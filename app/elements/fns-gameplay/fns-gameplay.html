<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">


<polymer-element name="fns-gameplay" attributes="game cat">
  <template>
    <link rel="stylesheet" href="fns-gameplay.css">
    <firebase-element id="base" on-data-change="{{handleResponse}}" data="{{data}}" location="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/"></firebase-element>
    <core-animated-pages selected="{{pageSelect}}">
      <section>
        <div vertical layout center>

        <core-icon-button on-tap="{{toggleLog}}" icon="drive-document"></core-icon-button>
        <h1>{{data.ploeg1}}</h1>
        <h2 on-tap="{{addPoint1}}">{{data.score1}}</h2>
        <core-icon-button icon="add-circle" on-tap="{{addPoint1}}"></core-icon-button>
        <core-icon-button icon="remove-circle" on-tap="{{removePoint1}}"></core-icon-button>

        <h1>{{data.ploeg2}}</h1>
        <h2 on-tap="{{addPoint2}}">{{data.score2}}</h2>
        <core-icon-button icon="add-circle" on-tap="{{addPoint2}}"></core-icon-button>
        <core-icon-button icon="remove-circle" on-tap="{{removePoint2}}"></core-icon-button>
        </div>
    </section>

    <section>
      <firebase-element id="cbase" on-data-change="{{handleComments}}" keys="{{ckeys}}" data="{{cdata}}" location="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/comments/"></firebase-element>
      <core-ajax method="POST" id="commPost" handleAs="json" data url="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/comments/.json"></core-ajax>
      <core-icon-button on-tap="{{toggleScore}}" icon="view-stream"></core-icon-button>
      <input id="comment" value="{{commentPost}}">
      <core-icon-button icon="submit" on-tap="{{postit}}">Toevoegen</core-icon-button>
      
      <template repeat="{{comm in comments}}">
      <p>{{comm.data.comment}}</p>
      </template>

    </section>
    </core-animated-pages>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        // define element prototype here
        ready: function(){
          this.pageSelect = 0;
        },

        toggleScore: function(){
          this.pageSelect = 0;
        },
        toggleLog: function(){
          this.pageSelect = 1;
        },

        postit: function(){
          var that = this;
          this.time = new Date();
          this.comm = { 'comment': that.commentPost, 'time': this.time };
          this.comm = JSON.stringify(this.comm);
          that.$.commPost.body = this.comm;
          that.$.commPost.go();
        },

        postLog: function(txt){
          var that = this;
          this.time = new Date();
          this.comm = { 'comment': txt, 'time': this.time };
          this.comm = JSON.stringify(this.comm);
          that.$.commPost.body = this.comm;
          that.$.commPost.go();
        },

        handleComments: function(){
          this.comments = [];
          //this.comments = this.data;
          for (var i = this.ckeys.length - 1; i >= 0; i--) {
            var j = this.ckeys[i];
              this.comments.push({'key': j, 'data': this.cdata[j]});
          };
          //berichten.sort(function(a,b){ return a.afstand - b.afstand});
        },

        gameChanged: function(){
          console.log('game changed: ', this.game, ' cat: ', this.cat);
          this.pageSelect = 0;
        },

        addPoint1: function(){
          var that = this;
          this.data.score1++; 
          that.postLog('Punt voor ploeg 1. De stand is '+this.data.score1+' - '+this.data.score2+'.');
        },

        addPoint2: function(){
          var that = this;
          this.data.score2++;
          that.postLog('Punt voor ploeg 2. De stand is '+this.data.score1+' - '+this.data.score2+'.'); 
        },

        removePoint1: function(){
          var that = this;
          this.data.score1--; 
          that.postLog('Foutje. De nieuwe stand is '+this.data.score1+' - '+this.data.score2+'.');
        },

        removePoint2: function(){
          var that = this;
          this.data.score2--;
          that.postLog('Foutje. De nieuwe stand is '+this.data.score1+' - '+this.data.score2+'.'); 
        }
      });

    })();
  </script>
</polymer-element>
