<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/time-ago/src/time-ago.html">
<link rel="import" href="../../elements/asl-globals/asl-globals.html">

<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.3/moment-with-locales.min.js"></script>

<polymer-element name="fns-gameplay" attributes="game cat">
  <template>
    <link rel="stylesheet" href="fns-gameplay.css">
    <firebase-element id="base" on-data-change="{{handleResponse}}" data="{{data}}" location="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/"></firebase-element>

        <asl-globals id="globals"></asl-globals>


        <div  vertical layout center class="breeeeed">


        <div  horizontal layout end class="breeeeed">
          <div class="ploeg"><h1>{{data.ploeg1}}</h1></div>
          <div class="ploeg"><h1>{{data.ploeg2}}</h1></div>
        </div>


        <div horizontal layout center class="breeeeed">

          <div vertical layout class="pointbtns" hidden?="{{isOwner}}">
            <core-icon-button icon="expand-less" on-tap="{{addPoint1}}" self-end class="pointbtn"></core-icon-button>
            <core-icon-button icon="expand-more" on-tap="{{removePoint1}}" self-end class="pointbtn"></core-icon-button>
          </div>
        <h2 class="score1" flex>{{data.score1}}</h2>
        <div class="streepje">|</div>
        <h2 class="score2" flex>{{data.score2}}</h2>
          <div vertical layout class="pointbtns" hidden?="{{isOwner}}">
            <core-icon-button icon="expand-less" on-tap="{{addPoint2}}" self-end class="pointbtn"></core-icon-button>
            <core-icon-button icon="expand-more" on-tap="{{removePoint2}}" self-end class="pointbtn"></core-icon-button>
          </div>
        </div>

    <div class="commstate" vertical layout center>
      <firebase-element id="cbase" on-data-change="{{handleComments}}" keys="{{ckeys}}" data="{{cdata}}" location="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/comments/"></firebase-element>
      <core-ajax method="POST" id="commPost" handleAs="json" data url="https://asl-ranking.firebaseio.com/categories/{{cat}}/games/{{game}}/comments/.json"></core-ajax>

      <div class="commentstate">

      <input id="comment" value="{{commentPost}}">
      <p>Own: {{data.owner}}</p>
      <paper-button icon="submit" on-tap="{{postit}}" class="addbtn">Toevoegen</paper-button>
      
      <template repeat="{{comm in comments}}">
        <div class="comments"><p><time-ago datetime="{{comm.data.time}}" delay="1000"></time-ago></p><p>{{comm.data.comment}}</p></div>
      </template>
    </div>

    </div>
  </div>

    </core-animated-pages>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        // define element prototype here
        ready: function(){
          this.pageSelect = 0;
          this.globals = this.$.globals;
        },

        toggleScore: function(){
          this.pageSelect = 0;
        },
        toggleLog: function(){
          this.pageSelect = 1;
        },

        postit: function(){
          var that = this;
          this.time = new Date();
          this.comm = { 'comment': that.commentPost, 'time': this.time };
          this.comm = JSON.stringify(this.comm);
          that.$.commPost.body = this.comm;
          that.$.commPost.go();
        },

        postLog: function(txt){
          var that = this;
          this.time = new Date();
          this.comm = { 'comment': txt, 'time': this.time };
          this.comm = JSON.stringify(this.comm);
          that.$.commPost.body = this.comm;
          that.$.commPost.go();
        },

        handleComments: function(){
          this.comments = [];
          //this.comments = this.data;
          for (var i = this.ckeys.length - 1; i >= 0; i--) {
            var j = this.ckeys[i];
              this.comments.push({'key': j, 'data': this.cdata[j]});
          };
          //berichten.sort(function(a,b){ return a.afstand - b.afstand});
        },

        gameChanged: function(){
          this.pageSelect = 0;
          this.isOwner = true;
        },

        addPoint1: function(){
          var that = this;
          this.data.score1++; 
          that.postLog('Punt voor ploeg 1. De stand is '+this.data.score1+' - '+this.data.score2+'.');
        },

        addPoint2: function(){
          var that = this;
          this.data.score2++;
          that.postLog('Punt voor ploeg 2. De stand is '+this.data.score1+' - '+this.data.score2+'.'); 
        },

        removePoint1: function(){
          var that = this;
          this.data.score1--; 
          that.postLog('Foutje. De nieuwe stand is '+this.data.score1+' - '+this.data.score2+'.');
        },

        removePoint2: function(){
          var that = this;
          this.data.score2--;
          that.postLog('Foutje. De nieuwe stand is '+this.data.score1+' - '+this.data.score2+'.'); 
        },

        handleResponse: function(){
          console.log('owner: ',this.data.owner);
          var that = this;
          console.log('user: ',that.globals.values.user.etag); 
          if(this.data.owner==that.globals.values.user.etag){
            console.log('user is owner.');
            that.isOwner = false;
          }
        }
      });

    })();
  </script>
</polymer-element>
